@page "/reiniciar-password"
@using Dtos
@using Servicios
@inject ServicioUsuario UsuarioService
@inject NavigationManager NavigationManager

<h3>Reiniciar Contraseña</h3>

<EditForm Model="@cambiarPassDto" OnValidSubmit="@ReiniciarPass">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Contraseña actual</label>
        <InputText class="form-control" @bind-Value="cambiarPassDto.ContraseniaActual" type="password" />
    </div>

    <div class="mb-3">
        <label class="form-label">Nueva contraseña</label>
        <InputText class="form-control" @bind-Value="cambiarPassDto.NuevaContrasenia" type="password" />
    </div>

    <div class="mb-3">
        <label class="form-label">Confirmar nueva contraseña</label>
        <InputText class="form-control" @bind-Value="cambiarPassDto.ConfirmarContrasenia" type="password" />
    </div>

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger">@mensajeError</div>
    }

    @if (exito)
    {
        <div class="alert alert-success">La contraseña fue actualizada correctamente.</div>
    }

    <button class="btn btn-primary" type="submit">Actualizar contraseña</button>
    <button class="btn btn-secondary ms-2" type="button" @onclick='() => NavigationManager.NavigateTo("/menu")'>Volver</button>
</EditForm>

@code {
    private CambiarPasswordDto cambiarPassDto = new CambiarPasswordDto();
    private string mensajeError = "";
    private bool exito = false;

    private void ReiniciarPass()
    {
        mensajeError = "";
        exito = false;

        if (cambiarPassDto.NuevaContrasenia != cambiarPassDto.ConfirmarContrasenia)
        {
            mensajeError = "La nueva contraseña y su confirmación no coinciden.";
            return;
        }

        try
        {
            UsuarioService.CambiarPasswordUsuario(cambiarPassDto); 
            exito = true;
            cambiarPassDto = new CambiarPasswordDto();

        }
        catch (ArgumentException ex)
        {
            mensajeError = ex.Message;
        }
        catch
        {
            mensajeError = "Ocurrió un error inesperado.";
        }
    }
}
