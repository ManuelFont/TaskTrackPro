@page "/menu"
@using Dtos
@using Servicios
@inject ServicioUsuario UsuarioService
@inject NavigationManager NavigationManager
@inject ServicioNotificaciones NotificacionesService

<h3>Menu</h3>

<div class="contenedor">
    <div class="barra-lateral">
        <div>
            <strong>@UsuarioService.UsuarioLogueado?.Nombre</strong><br />
            <small>@UsuarioService.UsuarioLogueado?.Email</small>
        </div>

        <h3>Proyectos</h3>
        @if (!_proyectos.Any())
        {
            <p>No tiene proyectos.</p>
        }
        else
        {
            <ul>
                @foreach (var proyecto in _proyectos) 
                {
                    <li class="proyecto-item"
                        @onclick="() => OnProyectoSeleccionado(proyecto)"
                        style="cursor:pointer">
                        @proyecto.NombreProyecto
                    </li>
                }
            </ul>
        }
        @if (UsuarioService.UsuarioActivoEsAdminProyecto())
        {
            <button class="btn btn-success mb-3"
                    @onclick='()=> NavigationManager.NavigateTo("/crear-proyecto")'>
            Agregar proyecto
            </button>
        }
        @if (UsuarioService.UsuarioActivoEsAdminSistema())
        {
            <h3>Recursos del Sistema</h3>
            <button class="btn btn-sm btn-primary mb-2" @onclick='() => NavigationManager.NavigateTo("/recursos")'>
                Ver y Crear Recursos
            </button>
            <button class="btn btn-sm btn-danger mb-2" @onclick='() => NavigationManager.NavigateTo("/eliminar-recursos")'>
                Editar / Eliminar Recursos
            </button>
            
            <h3>Usuarios</h3>
            <button class="btn btn-primary mb-3"
                    @onclick='() => NavigationManager.NavigateTo("/abm-usuarios")'>
                Gestión de usuarios
            </button>
            
            <h3>Exportar</h3>
            <button class="btn btn-primary mb-3"
                    @onclick='() => NavigationManager.NavigateTo("/exportar-json")'>
                Exportar Json
            </button>
            <button class="btn btn-primary mb-3"
                    @onclick='() => NavigationManager.NavigateTo("/exportar-csv")'>
                Exportar Csv
            </button>
           

        }

        @if (UsuarioService.UsuarioActivoEsAdminProyecto() || UsuarioService.UsuarioActivoEsAdminSistema())
        {
            <h3>Panel de Recursos</h3>
            <button class="btn btn-info mb-3"
                    @onclick='() => NavigationManager.NavigateTo("/panel-recursos")'>
                Ver Panel de Recursos
            </button>
        }

    </div>

    <div class="contenido-principal">
        <h4>Notificaciones</h4>
        @if (!_notificaciones.Any())
        {
            <p>No hay notificaciones nuevas.</p>
        }
        else
        {
            <ul class="list-group">
                @foreach (var noti in _notificaciones)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@noti.Mensaje</span>
                        <button class="btn btn-outline-primary btn-sm rounded"
                                @onclick="@(() => MarcarNotificacionComoVista(noti))"
                                title="Marcar como vista">
                            ✔
                        </button>
                    </li>
                }
            </ul>
        }

    </div>
</div>

<style>
    .contenedor {
        display: flex;
        height: 100vh;
    }

    .barra-lateral {
        width: 250px;
        background-color: #2c3e50;
        color: white;
        padding: 20px;
    }

    .barra-lateral h3 {
        margin-top: 20px;
    }

    .barra-lateral ul {
        list-style-type: none;
        padding-left: 0;
    }

    .barra-lateral li {
        margin-bottom: 10px;
        cursor: pointer;
    }
    
    .barra-lateral li.proyecto-item:hover {
        text-decoration: underline;
        background-color: #34495e;
        border-radius: 4px;
        padding-left: 4px;
    }

    .contenido-principal {
        flex: 1;
        padding: 40px;
        background-color: #f4f4f4;
    }

    .panel-notificaciones {
        margin-top: 30px;
        padding: 20px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
</style>

@code {
    private List<NotificacionDto> _notificaciones = new();
    private List<ProyectoDto> _proyectos = new();
    
    protected override void OnInitialized()
    {
        _proyectos = UsuarioService.ListarProyectosUsuarioLogueado();
        var usuarioLogueado = UsuarioService.UsuarioLogueado;
        if (usuarioLogueado != null)
        {
            _notificaciones = NotificacionesService.TraerNoVistas(usuarioLogueado.Email);
        }
    }

    private void MarcarNotificacionComoVista(NotificacionDto noti)
    {
        NotificacionesService.MarcarComoVista(noti.Id);
        _notificaciones.Remove(noti);
    }

    private void OnProyectoSeleccionado(ProyectoDto proyecto)
    {
        NavigationManager.NavigateTo($"/gestionar-proyecto/{proyecto.NombreProyecto}");
    }
}
