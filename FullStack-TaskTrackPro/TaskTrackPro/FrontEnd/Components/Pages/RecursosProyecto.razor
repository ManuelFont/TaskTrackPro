@page "/recursos-proyecto/{nombreProyecto}"
@using Dtos;
@using Servicios;
@inject ServicioRecurso RecursoServicio
@inject NavigationManager NavigationManager;

<h3 class="mb-4">Recursos Disponibles para Asignar al Proyecto</h3>

@if (_recursosDisponibles.Any())
{
    <div class="row row-cols-1 row-cols-md-2 g-4">
        @foreach (var recurso in _recursosDisponibles)
        {
            <div class="col">
                <div class="card shadow-sm rounded-3 h-100">
                    <div class="card-body">
                        <h5 class="card-title">@recurso.Nombre</h5>
                        <p class="card-text mb-1"><strong>Tipo:</strong> @recurso.Tipo</p>
                        <p class="card-text mb-1"><strong>Descripci√≥n:</strong> @recurso.Descripcion</p>
                        <p class="card-text mb-1"><strong>Funcionalidad:</strong> @recurso.Funcionalidad</p>
                        <button class="btn btn-sm btn-success mt-2"
                                @onclick="() => AsignarRecursoAProyecto(recurso)">
                            Asignar al Proyecto
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <p class="text-muted">No hay recursos disponibles para asignar.</p>
}

@if (!string.IsNullOrEmpty(mensajeExito))
{
    <div class="alert alert-success mt-3">@mensajeExito</div>
}
@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger mt-3">@mensajeError</div>
}

@code {
    [Parameter] public string nombreProyecto { get; set; } = "";

    private IList<RecursoDto> _recursosDisponibles = new List<RecursoDto>();
    private string mensajeError = "";
    private string mensajeExito = "";

    protected override void OnInitialized()
    {
        _recursosDisponibles = RecursoServicio
            .TraerTodo()
            .Where(r => string.IsNullOrEmpty(r.ProyectoNombre))
            .ToList();
    }

    private async Task AsignarRecursoAProyecto(RecursoDto recurso)
    {
        try
        {
            recurso.ProyectoNombre = nombreProyecto;
            RecursoServicio.Actualizar(recurso);

            mensajeExito = $"Recurso '{recurso.Nombre}' asignado correctamente.";

            await Task.Delay(1000);

            NavigationManager.NavigateTo($"/gestionar-proyecto/{nombreProyecto}");
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al asignar recurso: {ex.Message}";
        }
    }
}

